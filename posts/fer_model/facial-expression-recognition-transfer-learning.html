<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Onur Kerimoglu">
<meta name="dcterms.date" content="2023-02-06">

<title>OnurKerimoglu.github.io - Finetuning an ImageNet model for Facial Expression Recogntion</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">OnurKerimoglu.github.io</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://sites.google.com/view/onur-kerimoglu"><i class="bi bi-globe" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/onur-kerimoglu/"><i class="bi bi-linkedin" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/OnurKerimoglu"><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Finetuning an ImageNet model for Facial Expression Recogntion</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">code</div>
                <div class="quarto-category">analysis</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Onur Kerimoglu </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">February 6, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>In this notebook, we address the <a href="https://www.kaggle.com/c/challenges-in-representation-learning-facial-expression-recognition-challenge">facial expression recognition challenge</a> with transfer learning.</p>
<p>The data consists of 48x48 pixel grayscale images of faces. The faces have been automatically registered so that the face is more or less centered and occupies about the same amount of space in each image. The task is to categorize each face based on the emotion shown in the facial expression in to one of seven categories:</p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: center;">category</th>
<th style="text-align: left;">emotion</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">0</td>
<td style="text-align: left;">Angry</td>
</tr>
<tr class="even">
<td style="text-align: center;">1</td>
<td style="text-align: left;">Disgust</td>
</tr>
<tr class="odd">
<td style="text-align: center;">2</td>
<td style="text-align: left;">Fear</td>
</tr>
<tr class="even">
<td style="text-align: center;">3</td>
<td style="text-align: left;">Happy</td>
</tr>
<tr class="odd">
<td style="text-align: center;">4</td>
<td style="text-align: left;">Sad</td>
</tr>
<tr class="even">
<td style="text-align: center;">5</td>
<td style="text-align: left;">Surprise</td>
</tr>
<tr class="odd">
<td style="text-align: center;">6</td>
<td style="text-align: left;">Neutral</td>
</tr>
</tbody>
</table>
<p><a href="https://www.kaggle.com/drcapa">DrCapa</a> provided an excellent <a href="https://www.kaggle.com/code/drcapa/facial-expression-eda-cnn/notebook">notebook</a>, which presents a concise but nice data analysis, and a custom CNN model that achieves a testing accuracy of about 55%. Building on this work, I wanted to see if I can improve this by using pretrained MobileNet model, fine-tuning it, and including some data augmentation.</p>
</section>
<section id="libraries" class="level1">
<h1>Libraries</h1>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-01-23T19:02:08.079997Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-01-23T19:02:08.079276Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-01-23T19:02:13.002650Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-01-23T19:02:13.001870Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-01-23T17:43:00.752434Z&quot;}" data-papermill="{&quot;duration&quot;:4.961688,&quot;end_time&quot;:&quot;2023-01-23T19:02:13.002771&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2023-01-23T19:02:08.041083&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras <span class="im">import</span> models</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras.utils <span class="im">import</span> to_categorical, np_utils</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow <span class="im">import</span> convert_to_tensor</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.image <span class="im">import</span> grayscale_to_rgb</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.data <span class="im">import</span> Dataset</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.layers <span class="im">import</span> Flatten, Dense, GlobalAvgPool2D, GlobalMaxPool2D</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.callbacks <span class="im">import</span> Callback, EarlyStopping, ReduceLROnPlateau</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras <span class="im">import</span> optimizers</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.utils <span class="im">import</span> plot_model</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="load-prepare-data" class="level1">
<h1>Load &amp; Prepare Data</h1>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-01-23T19:02:13.225044Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-01-23T19:02:13.224520Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-01-23T19:02:13.232095Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-01-23T19:02:13.232543Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-01-23T17:43:05.125015Z&quot;}" data-papermill="{&quot;duration&quot;:0.046259,&quot;end_time&quot;:&quot;2023-01-23T19:02:13.232677&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2023-01-23T19:02:13.186418&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="3">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the input path and show all files</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> <span class="st">'/kaggle/input/challenges-in-representation-learning-facial-expression-recognition-challenge/'</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>os.listdir(path)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<pre><code>['icml_face_data.csv',
 'fer2013.tar.gz',
 'example_submission.csv',
 'train.csv',
 'test.csv']</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-01-23T19:02:13.305637Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-01-23T19:02:13.305100Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-01-23T19:02:20.040616Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-01-23T19:02:20.039519Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-01-23T17:43:05.142011Z&quot;}" data-papermill="{&quot;duration&quot;:6.774595,&quot;end_time&quot;:&quot;2023-01-23T19:02:20.040741&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2023-01-23T19:02:13.266146&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="4">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the image data with labels.</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> pd.read_csv(path<span class="op">+</span><span class="st">'icml_face_data.csv'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-01-23T19:02:20.125520Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-01-23T19:02:20.124700Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-01-23T19:02:20.132818Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-01-23T19:02:20.132374Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-01-23T17:43:11.582302Z&quot;}" data-papermill="{&quot;duration&quot;:0.055975,&quot;end_time&quot;:&quot;2023-01-23T19:02:20.132915&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2023-01-23T19:02:20.076940&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="5">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>data.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>emotion</th>
      <th>Usage</th>
      <th>pixels</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>Training</td>
      <td>70 80 82 72 58 58 60 63 54 58 60 48 89 115 121...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0</td>
      <td>Training</td>
      <td>151 150 147 155 148 133 111 140 170 174 182 15...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>Training</td>
      <td>231 212 156 164 174 138 161 173 182 200 106 38...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>Training</td>
      <td>24 32 36 30 32 23 19 20 30 41 21 22 32 34 21 1...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>6</td>
      <td>Training</td>
      <td>4 0 0 0 0 0 0 0 0 0 0 0 3 15 23 28 48 50 58 84...</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-01-23T19:02:20.214007Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-01-23T19:02:20.212368Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-01-23T19:02:20.218951Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-01-23T19:02:20.218516Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-01-23T17:43:11.605208Z&quot;}" data-papermill="{&quot;duration&quot;:0.049774,&quot;end_time&quot;:&quot;2023-01-23T19:02:20.219071&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2023-01-23T19:02:20.169297&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="6">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Overview </span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>data[<span class="st">' Usage'</span>].value_counts()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<pre><code>Training       28709
PublicTest      3589
PrivateTest     3589
Name:  Usage, dtype: int64</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-01-23T19:02:20.296154Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-01-23T19:02:20.295272Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-01-23T19:02:20.297547Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-01-23T19:02:20.298015Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-01-23T17:43:11.617551Z&quot;}" data-papermill="{&quot;duration&quot;:0.04318,&quot;end_time&quot;:&quot;2023-01-23T19:02:20.298134&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2023-01-23T19:02:20.254954&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="7">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>emotions <span class="op">=</span> {<span class="dv">0</span>: <span class="st">'Angry'</span>, <span class="dv">1</span>: <span class="st">'Disgust'</span>, <span class="dv">2</span>: <span class="st">'Fear'</span>, <span class="dv">3</span>: <span class="st">'Happy'</span>, <span class="dv">4</span>: <span class="st">'Sad'</span>, <span class="dv">5</span>: <span class="st">'Surprise'</span>, <span class="dv">6</span>: <span class="st">'Neutral'</span>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-01-23T19:02:20.379083Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-01-23T19:02:20.377081Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-01-23T19:02:20.379733Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-01-23T19:02:20.380154Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-01-23T17:43:11.625301Z&quot;}" data-papermill="{&quot;duration&quot;:0.046108,&quot;end_time&quot;:&quot;2023-01-23T19:02:20.380264&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2023-01-23T19:02:20.334156&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="8">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> prepare_data(data):</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">""" Prepare data for modeling </span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co">        input: data frame with labels und pixel data</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co">        output: image and label array """</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    image_array <span class="op">=</span> np.zeros(shape<span class="op">=</span>(<span class="bu">len</span>(data), <span class="dv">48</span>, <span class="dv">48</span>))</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    image_label <span class="op">=</span> np.array(<span class="bu">list</span>(<span class="bu">map</span>(<span class="bu">int</span>, data[<span class="st">'emotion'</span>])))</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, row <span class="kw">in</span> <span class="bu">enumerate</span>(data.index):</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>        image <span class="op">=</span> np.fromstring(data.loc[row, <span class="st">' pixels'</span>], dtype<span class="op">=</span><span class="bu">int</span>, sep<span class="op">=</span><span class="st">' '</span>)</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>        image <span class="op">=</span> np.reshape(image, (<span class="dv">48</span>, <span class="dv">48</span>))</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>        image_array[i] <span class="op">=</span> image</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> image_array, image_label</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Define training, validation and test data:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-01-23T19:02:20.529139Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-01-23T19:02:20.528275Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-01-23T19:02:23.406654Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-01-23T19:02:23.406121Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-01-23T17:43:11.636257Z&quot;}" data-papermill="{&quot;duration&quot;:2.919657,&quot;end_time&quot;:&quot;2023-01-23T19:02:23.406788&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2023-01-23T19:02:20.487131&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="9">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>train_image_array, train_image_label <span class="op">=</span> prepare_data(data[data[<span class="st">' Usage'</span>]<span class="op">==</span><span class="st">'Training'</span>])</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>val_image_array, val_image_label <span class="op">=</span> prepare_data(data[data[<span class="st">' Usage'</span>]<span class="op">==</span><span class="st">'PrivateTest'</span>])</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>test_image_array, test_image_label <span class="op">=</span> prepare_data(data[data[<span class="st">' Usage'</span>]<span class="op">==</span><span class="st">'PublicTest'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Reshape and scale the images:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-01-23T19:02:23.548912Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-01-23T19:02:23.547791Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-01-23T19:02:23.712823Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-01-23T19:02:23.713302Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-01-23T17:43:14.680455Z&quot;}" data-papermill="{&quot;duration&quot;:0.205164,&quot;end_time&quot;:&quot;2023-01-23T19:02:23.713504&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2023-01-23T19:02:23.508340&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="10">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>train_images <span class="op">=</span> train_image_array.reshape((train_image_array.shape[<span class="dv">0</span>], <span class="dv">48</span>, <span class="dv">48</span>, <span class="dv">1</span>))</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>train_images <span class="op">=</span> train_images.astype(<span class="st">'float32'</span>)<span class="op">/</span><span class="dv">255</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>val_images <span class="op">=</span> val_image_array.reshape((val_image_array.shape[<span class="dv">0</span>], <span class="dv">48</span>, <span class="dv">48</span>, <span class="dv">1</span>))</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>val_images <span class="op">=</span> val_images.astype(<span class="st">'float32'</span>)<span class="op">/</span><span class="dv">255</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>test_images <span class="op">=</span> test_image_array.reshape((test_image_array.shape[<span class="dv">0</span>], <span class="dv">48</span>, <span class="dv">48</span>, <span class="dv">1</span>))</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>test_images <span class="op">=</span> test_images.astype(<span class="st">'float32'</span>)<span class="op">/</span><span class="dv">255</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-01-23T19:02:25.622642Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-01-23T19:02:25.621433Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-01-23T19:02:26.296654Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-01-23T19:02:26.295818Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-01-23T17:43:14.848718Z&quot;}" data-papermill="{&quot;duration&quot;:2.545182,&quot;end_time&quot;:&quot;2023-01-23T19:02:26.296774&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2023-01-23T19:02:23.751592&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="11">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">#As the pretrained model expects rgb images, we convert our grayscale images with a single channel to pseudo-rgb images with 3 channels</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>train_images_rgb <span class="op">=</span> grayscale_to_rgb(convert_to_tensor(train_images))</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>val_images_rgb <span class="op">=</span> grayscale_to_rgb(convert_to_tensor(val_images))</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>test_images_rgb <span class="op">=</span>  grayscale_to_rgb(convert_to_tensor(test_images))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-01-23T19:02:26.370782Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-01-23T19:02:26.369742Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-01-23T19:02:27.269189Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-01-23T19:02:27.268711Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-01-23T17:43:17.184773Z&quot;}" data-papermill="{&quot;duration&quot;:0.938413,&quot;end_time&quot;:&quot;2023-01-23T19:02:27.269310&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2023-01-23T19:02:26.330897&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="12">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Data Augmentation using ImageDataGenerator</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="co">#sources:</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="co">#https://www.tensorflow.org/api_docs/python/tf/keras/preprocessing/image/ImageDataGenerator</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="co">#https://pyimagesearch.com/2019/07/08/keras-imagedatagenerator-and-data-augmentation/</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.preprocessing.image <span class="im">import</span> ImageDataGenerator</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>train_rgb_datagen <span class="op">=</span> ImageDataGenerator(</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    rotation_range<span class="op">=</span><span class="fl">0.15</span>,</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    width_shift_range<span class="op">=</span><span class="fl">0.15</span>,</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    height_shift_range<span class="op">=</span><span class="fl">0.15</span>,</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    shear_range<span class="op">=</span><span class="fl">0.15</span>,</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>    zoom_range<span class="op">=</span><span class="fl">0.15</span>,</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    horizontal_flip<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>    zca_whitening<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>train_rgb_datagen.fit(train_images_rgb)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Encoding of the target value:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-01-23T19:02:27.409268Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-01-23T19:02:27.408726Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-01-23T19:02:27.413599Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-01-23T19:02:27.413079Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-01-23T17:43:18.098420Z&quot;}" data-papermill="{&quot;duration&quot;:0.042322,&quot;end_time&quot;:&quot;2023-01-23T19:02:27.413741&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2023-01-23T19:02:27.371419&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="13">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>train_labels <span class="op">=</span> to_categorical(train_image_label)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>val_labels <span class="op">=</span> to_categorical(val_image_label)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>test_labels <span class="op">=</span> to_categorical(test_image_label)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="some-examples" class="level1">
<h1>Some Examples</h1>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-01-23T19:02:27.557859Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-01-23T19:02:27.557183Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-01-23T19:02:30.772902Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-01-23T19:02:30.774036Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-01-23T17:43:18.108171Z&quot;}" data-papermill="{&quot;duration&quot;:3.25836,&quot;end_time&quot;:&quot;2023-01-23T19:02:30.774175&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2023-01-23T19:02:27.515815&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="14">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_examples(label<span class="op">=</span><span class="dv">0</span>):</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    fig, axs <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">5</span>, figsize<span class="op">=</span>(<span class="dv">25</span>, <span class="dv">12</span>))</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    fig.subplots_adjust(hspace <span class="op">=</span> <span class="fl">.2</span>, wspace<span class="op">=</span><span class="fl">.2</span>)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    axs <span class="op">=</span> axs.ravel()</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">5</span>):</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>        idx <span class="op">=</span> data[data[<span class="st">'emotion'</span>]<span class="op">==</span>label].index[i]</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>        axs[i].imshow(train_images[idx][:,:,<span class="dv">0</span>], cmap<span class="op">=</span><span class="st">'gray'</span>)</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>        axs[i].set_title(emotions[train_labels[idx].argmax()])</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>        axs[i].set_xticklabels([])</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>        axs[i].set_yticklabels([])</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>plot_examples(label<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>plot_examples(label<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>plot_examples(label<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>plot_examples(label<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>plot_examples(label<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>plot_examples(label<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>plot_examples(label<span class="op">=</span><span class="dv">6</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="facial-expression-recognition-transfer-learning_files/figure-html/cell-14-output-1.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="facial-expression-recognition-transfer-learning_files/figure-html/cell-14-output-2.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="facial-expression-recognition-transfer-learning_files/figure-html/cell-14-output-3.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="facial-expression-recognition-transfer-learning_files/figure-html/cell-14-output-4.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="facial-expression-recognition-transfer-learning_files/figure-html/cell-14-output-5.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="facial-expression-recognition-transfer-learning_files/figure-html/cell-14-output-6.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="facial-expression-recognition-transfer-learning_files/figure-html/cell-14-output-7.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-01-23T19:02:30.865972Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-01-23T19:02:30.865150Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-01-23T19:02:30.912944Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-01-23T19:02:30.914066Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-01-23T18:59:15.633419Z&quot;}" data-papermill="{&quot;duration&quot;:0.098232,&quot;end_time&quot;:&quot;2023-01-23T19:02:30.914234&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2023-01-23T19:02:30.816002&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="15">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co">#In case we may want to save some examples:</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> PIL <span class="im">import</span> Image</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> save_all_emotions(channels<span class="op">=</span><span class="dv">1</span>, imgno<span class="op">=</span><span class="dv">0</span>):</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">7</span>):</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>        idx <span class="op">=</span> data[data[<span class="st">'emotion'</span>]<span class="op">==</span>i].index[imgno]</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>        emotion <span class="op">=</span> emotions[train_labels[idx].argmax()]</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>        img <span class="op">=</span> train_images[idx]</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> channels <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>            img <span class="op">=</span> img.squeeze()</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>: </span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>            img <span class="op">=</span> grayscale_to_rgb(convert_to_tensor(img)).numpy() <span class="co">#convert to tensor, then to 3ch, back to numpy</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>        img_shape <span class="op">=</span> img.shape</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>        <span class="co">#print(f'img shape: {img_shape[0]},{img_shape[1]}, type: {type(img)}') #(48,48)</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>        img <span class="op">=</span> img <span class="op">*</span> <span class="dv">255</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>        img <span class="op">=</span> img.astype(np.uint8)</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>        suf <span class="op">=</span> <span class="st">'_</span><span class="sc">%d</span><span class="st">_</span><span class="sc">%d</span><span class="st">_</span><span class="sc">%d</span><span class="st">'</span><span class="op">%</span>(img_shape[<span class="dv">0</span>],img_shape[<span class="dv">1</span>],channels)</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>        os.makedirs(<span class="st">'examples'</span><span class="op">+</span>suf, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>        fname <span class="op">=</span> os.path.join(<span class="st">'examples'</span><span class="op">+</span>suf, emotion<span class="op">+</span>suf<span class="op">+</span><span class="st">'.png'</span>)</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>        Image.fromarray(img).save(fname)</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'saved: </span><span class="sc">{</span>fname<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>save_all_emotions(channels<span class="op">=</span><span class="dv">3</span>,imgno<span class="op">=</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>saved: examples_48_48_3/Angry_48_48_3.png
saved: examples_48_48_3/Disgust_48_48_3.png
saved: examples_48_48_3/Fear_48_48_3.png
saved: examples_48_48_3/Happy_48_48_3.png
saved: examples_48_48_3/Sad_48_48_3.png
saved: examples_48_48_3/Surprise_48_48_3.png
saved: examples_48_48_3/Neutral_48_48_3.png</code></pre>
</div>
</div>
</section>
<section id="distribution-of-labels-class-weights" class="level1">
<h1>Distribution Of Labels &amp; Class Weights</h1>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-01-23T19:02:31.087595Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-01-23T19:02:31.086932Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-01-23T19:02:31.089599Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-01-23T19:02:31.089999Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-01-23T17:43:21.541671Z&quot;}" data-papermill="{&quot;duration&quot;:0.053276,&quot;end_time&quot;:&quot;2023-01-23T19:02:31.090113&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2023-01-23T19:02:31.036837&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="16">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_compare_distributions(array1, array2, title1<span class="op">=</span><span class="st">''</span>, title2<span class="op">=</span><span class="st">''</span>):</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>    df_array1 <span class="op">=</span> pd.DataFrame()</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    df_array2 <span class="op">=</span> pd.DataFrame()</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    df_array1[<span class="st">'emotion'</span>] <span class="op">=</span> array1.argmax(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    df_array2[<span class="st">'emotion'</span>] <span class="op">=</span> array2.argmax(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    fig, axs <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>), sharey<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> emotions.values()</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> df_array1[<span class="st">'emotion'</span>].value_counts()</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    keys_missed <span class="op">=</span> <span class="bu">list</span>(<span class="bu">set</span>(emotions.keys()).difference(<span class="bu">set</span>(y.keys())))</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> key_missed <span class="kw">in</span> keys_missed:</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>        y[key_missed] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    axs[<span class="dv">0</span>].bar(x, y.sort_index(), color<span class="op">=</span><span class="st">'orange'</span>)</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>    axs[<span class="dv">0</span>].set_title(title1)</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>    axs[<span class="dv">0</span>].grid()</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> df_array2[<span class="st">'emotion'</span>].value_counts()</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>    keys_missed <span class="op">=</span> <span class="bu">list</span>(<span class="bu">set</span>(emotions.keys()).difference(<span class="bu">set</span>(y.keys())))</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> key_missed <span class="kw">in</span> keys_missed:</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>        y[key_missed] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>    axs[<span class="dv">1</span>].bar(x, y.sort_index())</span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>    axs[<span class="dv">1</span>].set_title(title2)</span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>    axs[<span class="dv">1</span>].grid()</span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>    plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-01-23T19:02:31.177566Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-01-23T19:02:31.176678Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-01-23T19:02:31.389446Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-01-23T19:02:31.389877Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-01-23T17:43:21.554571Z&quot;}" data-papermill="{&quot;duration&quot;:0.259101,&quot;end_time&quot;:&quot;2023-01-23T19:02:31.389996&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2023-01-23T19:02:31.130895&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="17">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>plot_compare_distributions(train_labels, val_labels, title1<span class="op">=</span><span class="st">'train labels'</span>, title2<span class="op">=</span><span class="st">'val labels'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="facial-expression-recognition-transfer-learning_files/figure-html/cell-17-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Calculate the class weights of the label distribution:</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-01-23T19:02:31.566090Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-01-23T19:02:31.565333Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-01-23T19:02:31.578955Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-01-23T19:02:31.578544Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-01-23T17:43:21.915004Z&quot;}" data-papermill="{&quot;duration&quot;:0.06249,&quot;end_time&quot;:&quot;2023-01-23T19:02:31.579047&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2023-01-23T19:02:31.516557&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="18">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>class_weight <span class="op">=</span> <span class="bu">dict</span>(<span class="bu">zip</span>(<span class="bu">range</span>(<span class="dv">0</span>, <span class="dv">7</span>), (((data[data[<span class="st">' Usage'</span>]<span class="op">==</span><span class="st">'Training'</span>][<span class="st">'emotion'</span>].value_counts()).sort_index())<span class="op">/</span><span class="bu">len</span>(data[data[<span class="st">' Usage'</span>]<span class="op">==</span><span class="st">'Training'</span>][<span class="st">'emotion'</span>])).tolist()))</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>class_weight</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<pre><code>{0: 0.1391549688251071,
 1: 0.01518687519593159,
 2: 0.14270786164617366,
 3: 0.2513149186666202,
 4: 0.16823992476226968,
 5: 0.11045316799609878,
 6: 0.17294228290779895}</code></pre>
</div>
</div>
</section>
<section id="model" class="level1">
<h1>Model</h1>
<section id="general-defintions-and-helper-functions" class="level2">
<h2 class="anchored" data-anchor-id="general-defintions-and-helper-functions">General defintions and helper functions</h2>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-01-23T19:02:31.879403Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-01-23T19:02:31.877567Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-01-23T19:02:31.879985Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-01-23T19:02:31.880421Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-01-23T17:43:21.946710Z&quot;}" data-papermill="{&quot;duration&quot;:0.050836,&quot;end_time&quot;:&quot;2023-01-23T19:02:31.880538&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2023-01-23T19:02:31.829702&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="19">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Define callbacks</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>early_stopping <span class="op">=</span> EarlyStopping(</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    monitor<span class="op">=</span><span class="st">'val_accuracy'</span>,</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    min_delta<span class="op">=</span><span class="fl">0.00008</span>,</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    patience<span class="op">=</span><span class="dv">11</span>,</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    verbose<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    restore_best_weights<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>lr_scheduler <span class="op">=</span> ReduceLROnPlateau(</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>    monitor<span class="op">=</span><span class="st">'val_accuracy'</span>,</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>    min_delta<span class="op">=</span><span class="fl">0.0001</span>,</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>    factor<span class="op">=</span><span class="fl">0.25</span>,</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>    patience<span class="op">=</span><span class="dv">4</span>,</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>    min_lr<span class="op">=</span><span class="fl">1e-7</span>,</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>    verbose<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>callbacks <span class="op">=</span> [</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>    early_stopping,</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>    lr_scheduler,</span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-01-23T19:02:31.968899Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-01-23T19:02:31.967113Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-01-23T19:02:31.969611Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-01-23T19:02:31.970019Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-01-23T17:43:21.959271Z&quot;}" data-papermill="{&quot;duration&quot;:0.048029,&quot;end_time&quot;:&quot;2023-01-23T19:02:31.970124&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2023-01-23T19:02:31.922095&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="20">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co">#General shape parameters</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>IMG_SIZE <span class="op">=</span> <span class="dv">48</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>NUM_CLASSES <span class="op">=</span> <span class="dv">7</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>BATCH_SIZE <span class="op">=</span> <span class="dv">64</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-01-23T19:02:32.062388Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-01-23T19:02:32.061056Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-01-23T19:02:32.064060Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-01-23T19:02:32.063654Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-01-23T17:43:21.973849Z&quot;}" data-papermill="{&quot;duration&quot;:0.052456,&quot;end_time&quot;:&quot;2023-01-23T19:02:32.064149&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2023-01-23T19:02:32.011693&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="21">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co">#A plotting function to visualize training progress</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> render_history(history, suf<span class="op">=</span><span class="st">''</span>):</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    fig, (ax1, ax2) <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>)</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    plt.subplots_adjust(left<span class="op">=</span><span class="fl">0.1</span>,</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>                        bottom<span class="op">=</span><span class="fl">0.1</span>,</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>                        right<span class="op">=</span><span class="fl">0.95</span>,</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>                        top<span class="op">=</span><span class="fl">0.9</span>,</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>                        wspace<span class="op">=</span><span class="fl">0.4</span>)</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>    ax1.set_title(<span class="st">"Losses"</span>)</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>    ax1.plot(history.history[<span class="st">"loss"</span>], label<span class="op">=</span><span class="st">"loss"</span>)</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>    ax1.plot(history.history[<span class="st">"val_loss"</span>], label<span class="op">=</span><span class="st">"val_loss"</span>)</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>    ax1.set_xlabel(<span class="st">'epochs'</span>)</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>    ax1.set_ylabel(<span class="st">'value of the loss function'</span>)</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>    ax1.legend()</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>    ax2.set_title(<span class="st">"Accuracies"</span>)</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>    ax2.plot(history.history[<span class="st">"accuracy"</span>], label<span class="op">=</span><span class="st">"accuracy"</span>)</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>    ax2.plot(history.history[<span class="st">"val_accuracy"</span>], label<span class="op">=</span><span class="st">"val_accuracy"</span>)</span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>    ax2.set_xlabel(<span class="st">'epochs'</span>)</span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>    ax2.set_ylabel(<span class="st">'value of accuracy'</span>)</span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>    ax2.legend()</span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a>    suf <span class="op">=</span> <span class="st">''</span> <span class="cf">if</span> suf <span class="op">==</span> <span class="st">''</span> <span class="cf">else</span> <span class="st">'_'</span><span class="op">+</span>suf</span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a>    fig.savefig(<span class="st">'loss_and_acc'</span><span class="op">+</span>suf <span class="op">+</span><span class="st">'.png'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="model-construction" class="level2">
<h2 class="anchored" data-anchor-id="model-construction">Model construction</h2>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-01-23T19:02:32.237921Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-01-23T19:02:32.237417Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-01-23T19:02:33.453834Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-01-23T19:02:33.454390Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-01-23T17:43:21.992120Z&quot;}" data-papermill="{&quot;duration&quot;:1.265152,&quot;end_time&quot;:&quot;2023-01-23T19:02:33.454539&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2023-01-23T19:02:32.189387&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="22">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.applications <span class="im">import</span> MobileNet</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.models <span class="im">import</span> Model</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="co">#By specifying the include_top=False argument, we load a network that </span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="co">#doesn't include the  classification layers at the top, which is ideal for feature extraction.</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>base_net <span class="op">=</span> MobileNet(input_shape<span class="op">=</span>(IMG_SIZE, IMG_SIZE, <span class="dv">3</span>),</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>                     include_top<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>                     weights<span class="op">=</span><span class="st">'imagenet'</span>)</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a><span class="co">#plot_model(base_net, show_shapes=True, show_layer_names=True, expand_nested=True, dpi=50, to_file='mobilenet_full.png')</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Downloading data from https://storage.googleapis.com/tensorflow/keras-applications/mobilenet/mobilenet_1_0_224_tf_no_top.h5
17227776/17225924 [==============================] - 0s 0us/step</code></pre>
</div>
</div>
<p>For these small images, mobilenet is a very large model. Observing that there is nothing left to convolve further, we take the model only until the 12.block</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-01-23T19:02:33.630312Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-01-23T19:02:33.629786Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-01-23T19:02:33.644866Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-01-23T19:02:33.644446Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-01-23T17:43:24.211292Z&quot;}" data-papermill="{&quot;duration&quot;:0.062319,&quot;end_time&quot;:&quot;2023-01-23T19:02:33.644959&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2023-01-23T19:02:33.582640&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="23">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>base_model <span class="op">=</span> Model(inputs <span class="op">=</span> base_net.<span class="bu">input</span>,outputs <span class="op">=</span> base_net.get_layer(<span class="st">'conv_pw_12_relu'</span>).output, name <span class="op">=</span> <span class="st">'mobilenet_trunc'</span>)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="co">#this is the same as:</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="co">#base_model = Model(inputs = base_net.input,outputs = base_net.layers[-7].output)</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="co">#plot_model(base_model, show_shapes=True, show_layer_names=True, expand_nested=True, dpi=50, to_file='mobilenet_truncated.png')</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-01-23T19:02:33.779712Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-01-23T19:02:33.779127Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-01-23T19:02:34.719426Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-01-23T19:02:34.719871Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-01-23T17:43:24.234389Z&quot;}" data-papermill="{&quot;duration&quot;:0.995111,&quot;end_time&quot;:&quot;2023-01-23T19:02:34.719999&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2023-01-23T19:02:33.724888&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="24">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co">#from: https://www.tensorflow.org/tutorials/images/transfer_learning</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras <span class="im">import</span> Sequential, layers</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras <span class="im">import</span> Input, Model</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="co">#from tensor</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="co">#base_model.trainable = False</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a><span class="co">#This model expects pixel values in [-1, 1], but at this point, the pixel values in your images are in [0, 255]. </span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a><span class="co">#To rescale them, use the preprocessing method included with the model.</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a><span class="co">#preprocess_input = tf.keras.applications.mobilenet_v2.preprocess_input</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a><span class="co">#Add a classification head: To generate predictions from the block of features, </span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a><span class="co">#average over the spatial 2x2 spatial locations,  using a tf.keras.layers.GlobalAveragePooling2D layer </span></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a><span class="co">#to convert the features to a single 1280-element vector per image.</span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>global_average_layer <span class="op">=</span> GlobalAvgPool2D()</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a><span class="co">#feature_batch_average = global_average_layer(feature_batch)</span></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a><span class="co">#print(feature_batch_average.shape)</span></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a><span class="co">#Apply a tf.keras.layers.Dense layer to convert these features into a single prediction per image. </span></span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a><span class="co">#You don't need an activation function here because this prediction will be treated as a logit, </span></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a><span class="co">#or a raw prediction value. Positive numbers predict class 1, negative numbers predict class 0.</span></span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>prediction_layer <span class="op">=</span> Dense(NUM_CLASSES, activation<span class="op">=</span><span class="st">"softmax"</span>, name<span class="op">=</span><span class="st">"pred"</span>)</span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a><span class="co">#prediction_batch = prediction_layer(feature_batch_average)</span></span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a><span class="co">#print(prediction_batch.shape)</span></span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a><span class="co">#Build a model by chaining together the data augmentation, rescaling, base_model and feature extractor layers </span></span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a><span class="co">#using the Keras Functional API. As previously mentioned, use training=False as our model contains a BatchNormalization layer.</span></span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a>inputs_raw <span class="op">=</span> Input(shape<span class="op">=</span>(IMG_SIZE, IMG_SIZE, <span class="dv">3</span>))</span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a><span class="co">#inputs_pp = preprocess_input(inputs_aug)</span></span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a><span class="co">#x = base_model(inputs_pp, training=False)</span></span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> base_model(inputs_raw, training<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> global_average_layer(x)</span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a><span class="co">#x = tf.keras.layers.Dropout(0.2)(x)</span></span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a>outputs <span class="op">=</span> prediction_layer(x)</span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Model(inputs<span class="op">=</span>inputs_raw, outputs<span class="op">=</span> outputs)</span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a>model.summary()</span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a>plot_model(model, </span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true" tabindex="-1"></a>           show_shapes<span class="op">=</span><span class="va">True</span>, </span>
<span id="cb28-40"><a href="#cb28-40" aria-hidden="true" tabindex="-1"></a>           show_layer_names<span class="op">=</span><span class="va">True</span>, </span>
<span id="cb28-41"><a href="#cb28-41" aria-hidden="true" tabindex="-1"></a>           expand_nested<span class="op">=</span><span class="va">True</span>, </span>
<span id="cb28-42"><a href="#cb28-42" aria-hidden="true" tabindex="-1"></a>           dpi<span class="op">=</span><span class="dv">50</span>, </span>
<span id="cb28-43"><a href="#cb28-43" aria-hidden="true" tabindex="-1"></a>           to_file<span class="op">=</span><span class="st">'MobileNet12blocks_structure.png'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Model: "functional_1"
_________________________________________________________________
Layer (type)                 Output Shape              Param #   
=================================================================
input_2 (InputLayer)         [(None, 48, 48, 3)]       0         
_________________________________________________________________
mobilenet_trunc (Functional) (None, 1, 1, 1024)        2162880   
_________________________________________________________________
global_average_pooling2d (Gl (None, 1024)              0         
_________________________________________________________________
pred (Dense)                 (None, 7)                 7175      
=================================================================
Total params: 2,170,055
Trainable params: 2,152,263
Non-trainable params: 17,792
_________________________________________________________________</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="24">
<p><img src="facial-expression-recognition-transfer-learning_files/figure-html/cell-24-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-01-23T19:02:34.835966Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-01-23T19:02:34.831683Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-01-23T19:02:34.851462Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-01-23T19:02:34.851006Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-01-23T17:43:25.229324Z&quot;}" data-papermill="{&quot;duration&quot;:0.080628,&quot;end_time&quot;:&quot;2023-01-23T19:02:34.851567&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2023-01-23T19:02:34.770939&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="25">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Train the classification head:</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="co">#base_model.trainable = True #if we included the model layers, but not the model itself, this doesn't have any effect</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> layer <span class="kw">in</span> base_model.layers[:]:</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    layer.trainable <span class="op">=</span> <span class="va">False</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="co">#for layer in base_model.layers[81:]:</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="co">#    layer.trainable = True</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>optims <span class="op">=</span> {</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">'sgd'</span>: optimizers.SGD(lr<span class="op">=</span><span class="fl">0.1</span>, momentum<span class="op">=</span><span class="fl">0.9</span>, decay<span class="op">=</span><span class="fl">0.01</span>),</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">'adam'</span>: optimizers.Adam(<span class="fl">0.01</span>),</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">'nadam'</span>: optimizers.Nadam(learning_rate<span class="op">=</span><span class="fl">0.1</span>, beta_1<span class="op">=</span><span class="fl">0.9</span>, beta_2<span class="op">=</span><span class="fl">0.999</span>, epsilon<span class="op">=</span><span class="fl">1e-07</span>)</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>model.<span class="bu">compile</span>(</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>        loss<span class="op">=</span><span class="st">'categorical_crossentropy'</span>,</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>        optimizer<span class="op">=</span>optims[<span class="st">'adam'</span>],</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>        metrics<span class="op">=</span>[<span class="st">'accuracy'</span>]</span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>model.summary()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Model: "functional_1"
_________________________________________________________________
Layer (type)                 Output Shape              Param #   
=================================================================
input_2 (InputLayer)         [(None, 48, 48, 3)]       0         
_________________________________________________________________
mobilenet_trunc (Functional) (None, 1, 1, 1024)        2162880   
_________________________________________________________________
global_average_pooling2d (Gl (None, 1024)              0         
_________________________________________________________________
pred (Dense)                 (None, 7)                 7175      
=================================================================
Total params: 2,170,055
Trainable params: 7,175
Non-trainable params: 2,162,880
_________________________________________________________________</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-01-23T19:02:34.952231Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-01-23T19:02:34.951488Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-01-23T19:04:30.979070Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-01-23T19:04:30.980172Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-01-23T17:43:25.292076Z&quot;}" data-papermill="{&quot;duration&quot;:116.081808,&quot;end_time&quot;:&quot;2023-01-23T19:04:30.980380&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2023-01-23T19:02:34.898572&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="26">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>initial_epochs <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="co"># total_epochs = initial_epochs + 5</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>history <span class="op">=</span> model.fit_generator(train_rgb_datagen.flow(train_images_rgb, </span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>                                                 train_labels, </span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>                                                 batch_size<span class="op">=</span>BATCH_SIZE),</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>                              validation_data<span class="op">=</span>(val_images_rgb, </span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>                                               val_labels),</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>                              class_weight <span class="op">=</span> class_weight,</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>                              steps_per_epoch<span class="op">=</span><span class="bu">len</span>(train_images) <span class="op">/</span> BATCH_SIZE,</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>                              <span class="co">#initial_epoch = history.epoch[-1],</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>                              <span class="co">#epochs = total_epochs,</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>                              epochs <span class="op">=</span> initial_epochs,</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>                              callbacks<span class="op">=</span>callbacks,</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>                              use_multiprocessing<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch 1/5
449/448 [==============================] - 23s 51ms/step - loss: 0.3093 - accuracy: 0.3429 - val_loss: 1.8735 - val_accuracy: 0.3892
Epoch 2/5
449/448 [==============================] - 22s 49ms/step - loss: 0.2979 - accuracy: 0.3632 - val_loss: 1.9810 - val_accuracy: 0.3461
Epoch 3/5
449/448 [==============================] - 21s 47ms/step - loss: 0.2963 - accuracy: 0.3704 - val_loss: 1.9980 - val_accuracy: 0.4018
Epoch 4/5
449/448 [==============================] - 22s 50ms/step - loss: 0.3032 - accuracy: 0.3677 - val_loss: 2.1077 - val_accuracy: 0.3770
Epoch 5/5
449/448 [==============================] - 22s 49ms/step - loss: 0.2978 - accuracy: 0.3697 - val_loss: 1.8218 - val_accuracy: 0.3954</code></pre>
</div>
</div>
<section id="fine-tuning" class="level3">
<h3 class="anchored" data-anchor-id="fine-tuning">Fine-tuning</h3>
<p>Here I wanted to find out whether the training converges better or faster if the training is performed iteratively, whereby first the upper layers of the base_model is fine-tuned with a moderately slow learning rate (1e-3), then the entire base model will be fine-tuned in a second round with a small learning rate (1e-4). In the non-iterative approach, the whole base_model is trained with that smal learning rate (1e-4). However I did not see evidence for any advantage of the iterative approach, therefore I’ve set the ‘iterative_finetuning’ switch to False.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-01-23T19:04:33.276818Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-01-23T19:04:33.275901Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-01-23T19:04:33.277799Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-01-23T19:04:33.278212Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-01-23T17:45:25.880439Z&quot;}" data-papermill="{&quot;duration&quot;:0.360178,&quot;end_time&quot;:&quot;2023-01-23T19:04:33.278341&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2023-01-23T19:04:32.918163&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="27">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>iterative_finetuning <span class="op">=</span> <span class="va">False</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="first-iteration-partial-fine-tuning-of-the-base_model" class="level4">
<h4 class="anchored" data-anchor-id="first-iteration-partial-fine-tuning-of-the-base_model">First iteration: partial fine-tuning of the base_model</h4>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-01-23T19:04:34.696275Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-01-23T19:04:34.694486Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-01-23T19:04:34.696913Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-01-23T19:04:34.697319Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-01-23T17:45:25.895767Z&quot;}" data-papermill="{&quot;duration&quot;:0.363645,&quot;end_time&quot;:&quot;2023-01-23T19:04:34.697464&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2023-01-23T19:04:34.333819&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="28">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> iterative_finetuning:</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">#fine-tune the top layers (blocks 7-12):</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Let's take a look to see how many layers are in the base model</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Number of layers in the base model: "</span>, <span class="bu">len</span>(base_model.layers))</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">#base_model.trainable = True #if we included the model layers, but not the model itself, this doesn't have any effect</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> layer <span class="kw">in</span> base_model.layers:</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>        layer.trainable <span class="op">=</span> <span class="va">False</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> layer <span class="kw">in</span> base_model.layers[<span class="op">-</span><span class="dv">37</span>:]: <span class="co">#blocks 7-12</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>      layer.trainable <span class="op">=</span> <span class="va">True</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>    optims <span class="op">=</span> {</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">'sgd'</span>: optimizers.SGD(lr<span class="op">=</span><span class="fl">0.01</span>, momentum<span class="op">=</span><span class="fl">0.9</span>, decay<span class="op">=</span><span class="fl">0.01</span>),</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">'adam'</span>: optimizers.Adam(<span class="fl">0.001</span>),</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">'nadam'</span>: optimizers.Nadam(learning_rate<span class="op">=</span><span class="fl">0.01</span>, beta_1<span class="op">=</span><span class="fl">0.9</span>, beta_2<span class="op">=</span><span class="fl">0.999</span>, epsilon<span class="op">=</span><span class="fl">1e-07</span>)</span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>    model.<span class="bu">compile</span>(</span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>            loss<span class="op">=</span><span class="st">'categorical_crossentropy'</span>,</span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>            optimizer<span class="op">=</span>optims[<span class="st">'adam'</span>],</span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>            metrics<span class="op">=</span>[<span class="st">'accuracy'</span>]</span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>    model.summary()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-01-23T19:04:35.411695Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-01-23T19:04:35.409759Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-01-23T19:04:35.412311Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-01-23T19:04:35.412773Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-01-23T17:45:25.909422Z&quot;}" data-papermill="{&quot;duration&quot;:0.365032,&quot;end_time&quot;:&quot;2023-01-23T19:04:35.412895&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2023-01-23T19:04:35.047863&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="29">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> iterative_finetuning:</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>    fine_tune_epochs <span class="op">=</span> <span class="dv">40</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>    total_epochs <span class="op">=</span>  history.epoch[<span class="op">-</span><span class="dv">1</span>] <span class="op">+</span> fine_tune_epochs</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>    history <span class="op">=</span> model.fit_generator(train_rgb_datagen.flow(train_images_rgb, </span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>                                                     train_labels, </span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>                                                     batch_size<span class="op">=</span>BATCH_SIZE),</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>                                  validation_data<span class="op">=</span>(val_images_rgb, </span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>                                                   val_labels),</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>                                  class_weight <span class="op">=</span> class_weight,</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>                                  steps_per_epoch<span class="op">=</span><span class="bu">len</span>(train_images) <span class="op">/</span> BATCH_SIZE,</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>                                  initial_epoch <span class="op">=</span> history.epoch[<span class="op">-</span><span class="dv">1</span>],</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>                                  epochs <span class="op">=</span> total_epochs,</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>                                  callbacks<span class="op">=</span>callbacks,</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>                                  use_multiprocessing<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-01-23T19:04:36.125033Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-01-23T19:04:36.124483Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-01-23T19:04:36.128566Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-01-23T19:04:36.128111Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-01-23T17:45:25.926480Z&quot;}" data-papermill="{&quot;duration&quot;:0.359855,&quot;end_time&quot;:&quot;2023-01-23T19:04:36.128673&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2023-01-23T19:04:35.768818&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="30">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> iterative_finetuning:</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>    test_loss, test_acc <span class="op">=</span> model.evaluate(test_images_rgb, test_labels) <span class="co">#, test_labels</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'test caccuracy:'</span>, test_acc)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-01-23T19:04:36.915895Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-01-23T19:04:36.914963Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-01-23T19:04:36.919719Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-01-23T19:04:36.920164Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-01-23T17:45:25.941926Z&quot;}" data-papermill="{&quot;duration&quot;:0.433698,&quot;end_time&quot;:&quot;2023-01-23T19:04:36.920294&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2023-01-23T19:04:36.486596&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="31">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> iterative_finetuning:</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>    render_history(history, <span class="st">'mobilenet12blocks_wdgenaug_finetuning1'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="second-iteration-or-the-main-iteration-if-iterative_finetuning-was-set-to-false-fine-tuning-of-the-entire-base_model" class="level4">
<h4 class="anchored" data-anchor-id="second-iteration-or-the-main-iteration-if-iterative_finetuning-was-set-to-false-fine-tuning-of-the-entire-base_model">Second Iteration (or the main iteration, if iterative_finetuning was set to False): fine-tuning of the entire base_model</h4>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-01-23T19:04:38.599033Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-01-23T19:04:38.597484Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-01-23T19:04:38.599862Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-01-23T19:04:38.600300Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-01-23T17:45:25.948323Z&quot;}" data-papermill="{&quot;duration&quot;:0.377183,&quot;end_time&quot;:&quot;2023-01-23T19:04:38.600449&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2023-01-23T19:04:38.223266&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="32">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> iterative_finetuning:</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>    ftsuf <span class="op">=</span> <span class="st">'ft_2'</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>    ftsuf <span class="op">=</span> <span class="st">'ft_atonce'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-01-23T19:04:39.347733Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-01-23T19:04:39.346866Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-01-23T19:04:39.369632Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-01-23T19:04:39.370308Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-01-23T17:45:25.957588Z&quot;}" data-papermill="{&quot;duration&quot;:0.403649,&quot;end_time&quot;:&quot;2023-01-23T19:04:39.370486&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2023-01-23T19:04:38.966837&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="33">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co">#fine-tune all layers</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's take a look to see how many layers are in the base model</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Number of layers in the base model: "</span>, <span class="bu">len</span>(base_model.layers))</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a><span class="co">#base_model.trainable = True #if we included the model layers, but not the model itself, this doesn't have any effect</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> layer <span class="kw">in</span> base_model.layers:</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>    layer.trainable <span class="op">=</span> <span class="va">False</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> layer <span class="kw">in</span> base_model.layers[:]:</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>  layer.trainable <span class="op">=</span> <span class="va">True</span></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>optims <span class="op">=</span> {</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">'sgd'</span>: optimizers.SGD(lr<span class="op">=</span><span class="fl">0.01</span>, momentum<span class="op">=</span><span class="fl">0.9</span>, decay<span class="op">=</span><span class="fl">0.01</span>),</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">'adam'</span>: optimizers.Adam(<span class="fl">0.0001</span>),</span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">'nadam'</span>: optimizers.Nadam(learning_rate<span class="op">=</span><span class="fl">0.01</span>, beta_1<span class="op">=</span><span class="fl">0.9</span>, beta_2<span class="op">=</span><span class="fl">0.999</span>, epsilon<span class="op">=</span><span class="fl">1e-07</span>)</span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>model.<span class="bu">compile</span>(</span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>        loss<span class="op">=</span><span class="st">'categorical_crossentropy'</span>,</span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>        optimizer<span class="op">=</span>optims[<span class="st">'adam'</span>],</span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a>        metrics<span class="op">=</span>[<span class="st">'accuracy'</span>]</span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a>model.summary()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Number of layers in the base model:  81
Model: "functional_1"
_________________________________________________________________
Layer (type)                 Output Shape              Param #   
=================================================================
input_2 (InputLayer)         [(None, 48, 48, 3)]       0         
_________________________________________________________________
mobilenet_trunc (Functional) (None, 1, 1, 1024)        2162880   
_________________________________________________________________
global_average_pooling2d (Gl (None, 1024)              0         
_________________________________________________________________
pred (Dense)                 (None, 7)                 7175      
=================================================================
Total params: 2,170,055
Trainable params: 2,152,263
Non-trainable params: 17,792
_________________________________________________________________</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-01-23T19:04:40.073294Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-01-23T19:04:40.072195Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-01-23T19:24:44.299544Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-01-23T19:24:44.298810Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-01-23T17:45:26.012378Z&quot;}" data-papermill="{&quot;duration&quot;:1204.58118,&quot;end_time&quot;:&quot;2023-01-23T19:24:44.299694&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2023-01-23T19:04:39.718514&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="34">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>fine_tune_epochs <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>total_epochs <span class="op">=</span>  history.epoch[<span class="op">-</span><span class="dv">1</span>] <span class="op">+</span> fine_tune_epochs</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>history <span class="op">=</span> model.fit_generator(train_rgb_datagen.flow(train_images_rgb, </span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>                                                 train_labels, </span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>                                                 batch_size<span class="op">=</span>BATCH_SIZE),</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>                              validation_data<span class="op">=</span>(val_images_rgb, </span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>                                               val_labels),</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>                              class_weight <span class="op">=</span> class_weight,</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>                              steps_per_epoch<span class="op">=</span><span class="bu">len</span>(train_images) <span class="op">/</span> BATCH_SIZE,</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>                              initial_epoch <span class="op">=</span> history.epoch[<span class="op">-</span><span class="dv">1</span>],</span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>                              epochs <span class="op">=</span> total_epochs,</span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>                              callbacks<span class="op">=</span>callbacks,</span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>                              use_multiprocessing<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch 5/104
449/448 [==============================] - 25s 56ms/step - loss: 0.2373 - accuracy: 0.4185 - val_loss: 1.4505 - val_accuracy: 0.4728
Epoch 6/104
449/448 [==============================] - 24s 54ms/step - loss: 0.2106 - accuracy: 0.4788 - val_loss: 1.3257 - val_accuracy: 0.5096
Epoch 7/104
449/448 [==============================] - 24s 54ms/step - loss: 0.1995 - accuracy: 0.5043 - val_loss: 1.2294 - val_accuracy: 0.5411
Epoch 8/104
449/448 [==============================] - 25s 55ms/step - loss: 0.1947 - accuracy: 0.5164 - val_loss: 1.2620 - val_accuracy: 0.5272
Epoch 9/104
449/448 [==============================] - 24s 54ms/step - loss: 0.1886 - accuracy: 0.5320 - val_loss: 1.2909 - val_accuracy: 0.5032
Epoch 10/104
449/448 [==============================] - 24s 54ms/step - loss: 0.1853 - accuracy: 0.5416 - val_loss: 1.1900 - val_accuracy: 0.5634
Epoch 11/104
449/448 [==============================] - 25s 56ms/step - loss: 0.1797 - accuracy: 0.5533 - val_loss: 1.1744 - val_accuracy: 0.5717
Epoch 12/104
449/448 [==============================] - 24s 54ms/step - loss: 0.1780 - accuracy: 0.5587 - val_loss: 1.2182 - val_accuracy: 0.5425
Epoch 13/104
449/448 [==============================] - 25s 56ms/step - loss: 0.1744 - accuracy: 0.5685 - val_loss: 1.1660 - val_accuracy: 0.5665
Epoch 14/104
449/448 [==============================] - 25s 55ms/step - loss: 0.1719 - accuracy: 0.5716 - val_loss: 1.1556 - val_accuracy: 0.5740
Epoch 15/104
449/448 [==============================] - 25s 55ms/step - loss: 0.1707 - accuracy: 0.5766 - val_loss: 1.1153 - val_accuracy: 0.5924
Epoch 16/104
449/448 [==============================] - 25s 56ms/step - loss: 0.1676 - accuracy: 0.5822 - val_loss: 1.1014 - val_accuracy: 0.5890
Epoch 17/104
449/448 [==============================] - 25s 56ms/step - loss: 0.1658 - accuracy: 0.5891 - val_loss: 1.0770 - val_accuracy: 0.6088
Epoch 18/104
449/448 [==============================] - 25s 56ms/step - loss: 0.1645 - accuracy: 0.5895 - val_loss: 1.0803 - val_accuracy: 0.6013
Epoch 19/104
449/448 [==============================] - 24s 54ms/step - loss: 0.1615 - accuracy: 0.5985 - val_loss: 1.0768 - val_accuracy: 0.5952
Epoch 20/104
449/448 [==============================] - 25s 56ms/step - loss: 0.1602 - accuracy: 0.6019 - val_loss: 1.0971 - val_accuracy: 0.5932
Epoch 21/104
449/448 [==============================] - ETA: 0s - loss: 0.1591 - accuracy: 0.6041
Epoch 00021: ReduceLROnPlateau reducing learning rate to 2.499999936844688e-05.
449/448 [==============================] - 26s 57ms/step - loss: 0.1591 - accuracy: 0.6041 - val_loss: 1.0884 - val_accuracy: 0.6007
Epoch 22/104
449/448 [==============================] - 25s 56ms/step - loss: 0.1487 - accuracy: 0.6299 - val_loss: 1.0391 - val_accuracy: 0.6158
Epoch 23/104
449/448 [==============================] - 24s 54ms/step - loss: 0.1465 - accuracy: 0.6351 - val_loss: 1.0547 - val_accuracy: 0.6158
Epoch 24/104
449/448 [==============================] - 26s 57ms/step - loss: 0.1455 - accuracy: 0.6372 - val_loss: 1.0437 - val_accuracy: 0.6141
Epoch 25/104
449/448 [==============================] - 26s 57ms/step - loss: 0.1449 - accuracy: 0.6379 - val_loss: 1.0374 - val_accuracy: 0.6236
Epoch 26/104
449/448 [==============================] - 25s 57ms/step - loss: 0.1441 - accuracy: 0.6361 - val_loss: 1.0269 - val_accuracy: 0.6216
Epoch 27/104
449/448 [==============================] - 24s 53ms/step - loss: 0.1426 - accuracy: 0.6414 - val_loss: 1.0445 - val_accuracy: 0.6186
Epoch 28/104
449/448 [==============================] - 26s 58ms/step - loss: 0.1431 - accuracy: 0.6438 - val_loss: 1.0358 - val_accuracy: 0.6213
Epoch 29/104
449/448 [==============================] - 26s 57ms/step - loss: 0.1406 - accuracy: 0.6493 - val_loss: 1.0244 - val_accuracy: 0.6239
Epoch 30/104
449/448 [==============================] - 26s 59ms/step - loss: 0.1409 - accuracy: 0.6473 - val_loss: 1.0648 - val_accuracy: 0.6124
Epoch 31/104
449/448 [==============================] - 24s 54ms/step - loss: 0.1405 - accuracy: 0.6517 - val_loss: 1.0506 - val_accuracy: 0.6158
Epoch 32/104
449/448 [==============================] - 26s 57ms/step - loss: 0.1392 - accuracy: 0.6518 - val_loss: 1.0222 - val_accuracy: 0.6208
Epoch 33/104
448/448 [============================&gt;.] - ETA: 0s - loss: 0.1391 - accuracy: 0.6556
Epoch 00033: ReduceLROnPlateau reducing learning rate to 6.24999984211172e-06.
449/448 [==============================] - 27s 59ms/step - loss: 0.1391 - accuracy: 0.6554 - val_loss: 1.0329 - val_accuracy: 0.6208
Epoch 34/104
449/448 [==============================] - 26s 58ms/step - loss: 0.1348 - accuracy: 0.6613 - val_loss: 1.0199 - val_accuracy: 0.6255
Epoch 35/104
449/448 [==============================] - 25s 55ms/step - loss: 0.1338 - accuracy: 0.6652 - val_loss: 1.0257 - val_accuracy: 0.6280
Epoch 36/104
449/448 [==============================] - 27s 59ms/step - loss: 0.1326 - accuracy: 0.6690 - val_loss: 1.0187 - val_accuracy: 0.6219
Epoch 37/104
449/448 [==============================] - 26s 58ms/step - loss: 0.1335 - accuracy: 0.6651 - val_loss: 1.0161 - val_accuracy: 0.6297
Epoch 38/104
449/448 [==============================] - 23s 52ms/step - loss: 0.1330 - accuracy: 0.6678 - val_loss: 1.0254 - val_accuracy: 0.6252
Epoch 39/104
449/448 [==============================] - 27s 59ms/step - loss: 0.1326 - accuracy: 0.6685 - val_loss: 1.0133 - val_accuracy: 0.6317
Epoch 40/104
449/448 [==============================] - 27s 59ms/step - loss: 0.1327 - accuracy: 0.6673 - val_loss: 1.0138 - val_accuracy: 0.6330
Epoch 41/104
449/448 [==============================] - 27s 60ms/step - loss: 0.1323 - accuracy: 0.6703 - val_loss: 1.0157 - val_accuracy: 0.6261
Epoch 42/104
449/448 [==============================] - 25s 56ms/step - loss: 0.1330 - accuracy: 0.6685 - val_loss: 1.0189 - val_accuracy: 0.6289
Epoch 43/104
449/448 [==============================] - 26s 58ms/step - loss: 0.1326 - accuracy: 0.6675 - val_loss: 1.0165 - val_accuracy: 0.6283
Epoch 44/104
448/448 [============================&gt;.] - ETA: 0s - loss: 0.1317 - accuracy: 0.6701
Epoch 00044: ReduceLROnPlateau reducing learning rate to 1.56249996052793e-06.
449/448 [==============================] - 27s 60ms/step - loss: 0.1317 - accuracy: 0.6701 - val_loss: 1.0146 - val_accuracy: 0.6280
Epoch 45/104
449/448 [==============================] - 24s 54ms/step - loss: 0.1308 - accuracy: 0.6737 - val_loss: 1.0165 - val_accuracy: 0.6300
Epoch 46/104
449/448 [==============================] - 27s 61ms/step - loss: 0.1309 - accuracy: 0.6746 - val_loss: 1.0142 - val_accuracy: 0.6317
Epoch 47/104
449/448 [==============================] - 27s 61ms/step - loss: 0.1297 - accuracy: 0.6779 - val_loss: 1.0161 - val_accuracy: 0.6278
Epoch 48/104
449/448 [==============================] - ETA: 0s - loss: 0.1298 - accuracy: 0.6748
Epoch 00048: ReduceLROnPlateau reducing learning rate to 3.906249901319825e-07.
449/448 [==============================] - 24s 54ms/step - loss: 0.1298 - accuracy: 0.6748 - val_loss: 1.0151 - val_accuracy: 0.6328
Epoch 49/104
449/448 [==============================] - 24s 53ms/step - loss: 0.1296 - accuracy: 0.6771 - val_loss: 1.0138 - val_accuracy: 0.6328
Epoch 50/104
449/448 [==============================] - 28s 62ms/step - loss: 0.1306 - accuracy: 0.6742 - val_loss: 1.0144 - val_accuracy: 0.6328
Epoch 51/104
448/448 [============================&gt;.] - ETA: 0s - loss: 0.1293 - accuracy: 0.6780Restoring model weights from the end of the best epoch.
449/448 [==============================] - 24s 54ms/step - loss: 0.1293 - accuracy: 0.6780 - val_loss: 1.0146 - val_accuracy: 0.6328
Epoch 00051: early stopping</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-01-23T19:24:52.860416Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-01-23T19:24:52.859494Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-01-23T19:24:53.491691Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-01-23T19:24:53.491209Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-01-23T18:01:42.109652Z&quot;}" data-papermill="{&quot;duration&quot;:4.69466,&quot;end_time&quot;:&quot;2023-01-23T19:24:53.491815&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2023-01-23T19:24:48.797155&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="35">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>test_loss, test_acc <span class="op">=</span> model.evaluate(test_images_rgb, test_labels) <span class="co">#, test_labels</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'test caccuracy:'</span>, test_acc)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>113/113 [==============================] - 0s 4ms/step - loss: 1.0364 - accuracy: 0.6236
test caccuracy: 0.623572051525116</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-01-23T19:25:02.387310Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-01-23T19:25:02.385187Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-01-23T19:25:02.700438Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-01-23T19:25:02.699950Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-01-23T18:01:43.001704Z&quot;}" data-papermill="{&quot;duration&quot;:5.151166,&quot;end_time&quot;:&quot;2023-01-23T19:25:02.700561&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2023-01-23T19:24:57.549395&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="36">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>render_history(history, <span class="st">'mobilenet12blocks_wdgenaug_'</span><span class="op">+</span>ftsuf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="facial-expression-recognition-transfer-learning_files/figure-html/cell-36-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-01-23T19:25:11.156837Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-01-23T19:25:11.155994Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-01-23T19:25:11.822313Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-01-23T19:25:11.820920Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-01-23T18:01:43.357887Z&quot;}" data-papermill="{&quot;duration&quot;:5.053606,&quot;end_time&quot;:&quot;2023-01-23T19:25:11.822447&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2023-01-23T19:25:06.768841&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="37">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>pred_test_labels <span class="op">=</span> model.predict(test_images_rgb)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-01-23T19:25:20.119968Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-01-23T19:25:20.119073Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-01-23T19:25:20.628773Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-01-23T19:25:20.629256Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-01-23T18:01:44.040382Z&quot;}" data-papermill="{&quot;duration&quot;:4.776737,&quot;end_time&quot;:&quot;2023-01-23T19:25:20.629419&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2023-01-23T19:25:15.852682&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="38">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>model_yaml <span class="op">=</span> model.to_yaml()</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'MobileNet12blocks_wdgenaug_onrawdata_valacc_'</span> <span class="op">+</span> ftsuf <span class="op">+</span> <span class="st">'.yaml'</span>, <span class="st">'w'</span>) <span class="im">as</span> yaml_file:</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>    yaml_file.write(model_yaml)</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>model.save(<span class="st">'MobileNet12blocks_wdgenaug_onrawdata_valacc_'</span> <span class="op">+</span> ftsuf <span class="op">+</span> <span class="st">'.h5'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
</section>
</section>
<section id="analyse-results" class="level1">
<h1>Analyse Results</h1>
<section id="analyze-the-predictions-made-for-the-test-data" class="level3">
<h3 class="anchored" data-anchor-id="analyze-the-predictions-made-for-the-test-data">Analyze the predictions made for the test data</h3>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-01-23T19:25:46.200499Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-01-23T19:25:46.199670Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-01-23T19:25:46.202028Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-01-23T19:25:46.202419Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-01-23T18:47:29.708628Z&quot;}" data-papermill="{&quot;duration&quot;:4.179123,&quot;end_time&quot;:&quot;2023-01-23T19:25:46.202545&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2023-01-23T19:25:42.023422&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="39">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_image_and_emotion(test_image_array, test_image_label, pred_test_labels, image_number):</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">""" Function to plot the image and compare the prediction results with the label """</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>    fig, axs <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>), sharey<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>    bar_label <span class="op">=</span> emotions.values()</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>    axs[<span class="dv">0</span>].imshow(test_image_array[image_number], <span class="st">'gray'</span>)</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>    axs[<span class="dv">0</span>].set_title(emotions[test_image_label[image_number]])</span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>    axs[<span class="dv">1</span>].bar(bar_label, pred_test_labels[image_number], color<span class="op">=</span><span class="st">'orange'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>    axs[<span class="dv">1</span>].grid()</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>    plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-01-23T19:25:54.603371Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-01-23T19:25:54.602405Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-01-23T19:25:54.831422Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-01-23T19:25:54.831854Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-01-23T18:47:31.865969Z&quot;}" data-papermill="{&quot;duration&quot;:4.563922,&quot;end_time&quot;:&quot;2023-01-23T19:25:54.831981&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2023-01-23T19:25:50.268059&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="40">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> ipywidgets <span class="im">as</span> widgets</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="at">@widgets.interact</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> f(x<span class="op">=</span><span class="dv">106</span>):</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">#print(x)</span></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>    plot_image_and_emotion(test_image_array, test_image_label, pred_test_labels, x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="facial-expression-recognition-transfer-learning_files/figure-html/cell-40-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="make-inference-for-a-single-image-from-scratch" class="level3">
<h3 class="anchored" data-anchor-id="make-inference-for-a-single-image-from-scratch">Make inference for a single image from scratch:</h3>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-01-23T19:26:12.023340Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-01-23T19:26:12.022264Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-01-23T19:26:12.024028Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-01-23T19:26:12.024463Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-01-23T18:47:51.754528Z&quot;}" data-papermill="{&quot;duration&quot;:4.067158,&quot;end_time&quot;:&quot;2023-01-23T19:26:12.024584&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2023-01-23T19:26:07.957426&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="41">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> predict_emotion_of_image(test_image_array, test_image_label, pred_test_labels, image_number):</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>    input_arr <span class="op">=</span> test_image_array[image_number]<span class="op">/</span><span class="dv">255</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>    input_arr <span class="op">=</span> input_arr.reshape((<span class="dv">48</span>, <span class="dv">48</span>, <span class="dv">1</span>))</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>    input_arr_rgb <span class="op">=</span>  grayscale_to_rgb(convert_to_tensor(input_arr))</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>    predictions <span class="op">=</span> model.predict(np.array([input_arr_rgb]))</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>    predictions_f <span class="op">=</span> [<span class="st">'</span><span class="sc">%s</span><span class="st">:</span><span class="sc">%5.2f</span><span class="st">'</span><span class="op">%</span>(emotions[i],p<span class="op">*</span><span class="dv">100</span>) <span class="cf">for</span> i,p <span class="kw">in</span> <span class="bu">enumerate</span>(predictions[<span class="dv">0</span>])]</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>    label <span class="op">=</span> emotions[test_image_label[image_number]]</span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="ss">f'Label: </span><span class="sc">{</span>label<span class="sc">}</span><span class="ch">\n</span><span class="ss">Predictions: </span><span class="sc">{</span>predictions_f<span class="sc">}</span><span class="ss">'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-01-23T19:26:20.387967Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-01-23T19:26:20.386558Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-01-23T19:26:22.132838Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-01-23T19:26:22.131941Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-01-23T18:47:53.137687Z&quot;}" data-papermill="{&quot;duration&quot;:5.831854,&quot;end_time&quot;:&quot;2023-01-23T19:26:22.132962&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2023-01-23T19:26:16.301108&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="42">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> ipywidgets <span class="im">as</span> widgets</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="at">@widgets.interact</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> f(x<span class="op">=</span><span class="dv">106</span>):</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> predict_emotion_of_image(test_image_array, test_image_label, pred_test_labels, x)</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(result)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Label: Neutral
Predictions: ['Angry: 7.62', 'Disgust: 0.10', 'Fear: 3.06', 'Happy: 0.14', 'Sad: 5.54', 'Surprise: 0.56', 'Neutral:82.98']</code></pre>
</div>
</div>
</section>
<section id="compare-the-distribution-of-labels-and-predicted-labels" class="level2">
<h2 class="anchored" data-anchor-id="compare-the-distribution-of-labels-and-predicted-labels">Compare the distribution of labels and predicted labels</h2>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-01-23T19:26:39.438227Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-01-23T19:26:39.437279Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-01-23T19:26:39.439747Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-01-23T19:26:39.440129Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-01-23T18:47:55.898719Z&quot;}" data-papermill="{&quot;duration&quot;:4.397963,&quot;end_time&quot;:&quot;2023-01-23T19:26:39.440266&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2023-01-23T19:26:35.042303&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="43">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_compare_distributions(array1, array2, title1<span class="op">=</span><span class="st">''</span>, title2<span class="op">=</span><span class="st">''</span>):</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>    df_array1 <span class="op">=</span> pd.DataFrame()</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>    df_array2 <span class="op">=</span> pd.DataFrame()</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>    df_array1[<span class="st">'emotion'</span>] <span class="op">=</span> array1.argmax(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>    df_array2[<span class="st">'emotion'</span>] <span class="op">=</span> array2.argmax(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>    fig, axs <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>), sharey<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> emotions.values()</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> df_array1[<span class="st">'emotion'</span>].value_counts()</span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>    keys_missed <span class="op">=</span> <span class="bu">list</span>(<span class="bu">set</span>(emotions.keys()).difference(<span class="bu">set</span>(y.keys())))</span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> key_missed <span class="kw">in</span> keys_missed:</span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>        y[key_missed] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a>    axs[<span class="dv">0</span>].bar(x, y.sort_index(), color<span class="op">=</span><span class="st">'orange'</span>)</span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a>    axs[<span class="dv">0</span>].set_title(title1)</span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a>    axs[<span class="dv">0</span>].grid()</span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> df_array2[<span class="st">'emotion'</span>].value_counts()</span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a>    keys_missed <span class="op">=</span> <span class="bu">list</span>(<span class="bu">set</span>(emotions.keys()).difference(<span class="bu">set</span>(y.keys())))</span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> key_missed <span class="kw">in</span> keys_missed:</span>
<span id="cb54-21"><a href="#cb54-21" aria-hidden="true" tabindex="-1"></a>        y[key_missed] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb54-22"><a href="#cb54-22" aria-hidden="true" tabindex="-1"></a>    axs[<span class="dv">1</span>].bar(x, y.sort_index())</span>
<span id="cb54-23"><a href="#cb54-23" aria-hidden="true" tabindex="-1"></a>    axs[<span class="dv">1</span>].set_title(title2)</span>
<span id="cb54-24"><a href="#cb54-24" aria-hidden="true" tabindex="-1"></a>    axs[<span class="dv">1</span>].grid()</span>
<span id="cb54-25"><a href="#cb54-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-26"><a href="#cb54-26" aria-hidden="true" tabindex="-1"></a>    plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-01-23T19:26:47.623922Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-01-23T19:26:47.623128Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-01-23T19:26:47.919593Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-01-23T19:26:47.920289Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-01-23T18:47:57.780302Z&quot;}" data-papermill="{&quot;duration&quot;:4.306023,&quot;end_time&quot;:&quot;2023-01-23T19:26:47.920460&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2023-01-23T19:26:43.614437&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="44">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>plot_compare_distributions(test_labels, pred_test_labels, title1<span class="op">=</span><span class="st">'test labels'</span>, title2<span class="op">=</span><span class="st">'predict labels'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="facial-expression-recognition-transfer-learning_files/figure-html/cell-44-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="wrong-predictions" class="level2">
<h2 class="anchored" data-anchor-id="wrong-predictions">Wrong Predictions</h2>
<p>The accuracy score is about 63% on the test set. Let’s try to understand where the model is doing wrong.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-01-23T19:27:04.538769Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-01-23T19:27:04.537628Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-01-23T19:27:04.542552Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-01-23T19:27:04.541992Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-01-23T18:01:44.965714Z&quot;}" data-papermill="{&quot;duration&quot;:4.043179,&quot;end_time&quot;:&quot;2023-01-23T19:27:04.542663&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2023-01-23T19:27:00.499484&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="45">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>df_compare <span class="op">=</span> pd.DataFrame()</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>df_compare[<span class="st">'real'</span>] <span class="op">=</span> test_labels.argmax(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>df_compare[<span class="st">'pred'</span>] <span class="op">=</span> pred_test_labels.argmax(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>df_compare[<span class="st">'wrong'</span>] <span class="op">=</span> np.where(df_compare[<span class="st">'real'</span>]<span class="op">!=</span>df_compare[<span class="st">'pred'</span>], <span class="dv">1</span>, <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-01-23T19:27:13.391976Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-01-23T19:27:13.391120Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-01-23T19:27:14.438677Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-01-23T19:27:14.439128Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-01-23T18:01:44.978215Z&quot;}" data-papermill="{&quot;duration&quot;:5.380627,&quot;end_time&quot;:&quot;2023-01-23T19:27:14.439379&quot;,&quot;exception&quot;:false,&quot;start_time&quot;:&quot;2023-01-23T19:27:09.058752&quot;,&quot;status&quot;:&quot;completed&quot;}" data-tags="[]" data-execution_count="46">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> confusion_matrix</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> mlxtend.plotting <span class="im">import</span> plot_confusion_matrix</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>conf_mat <span class="op">=</span> confusion_matrix(test_labels.argmax(axis<span class="op">=</span><span class="dv">1</span>), pred_test_labels.argmax(axis<span class="op">=</span><span class="dv">1</span>))</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plot_confusion_matrix(conf_mat<span class="op">=</span>conf_mat,</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>                                show_normed<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>                                show_absolute<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>                                class_names<span class="op">=</span>emotions.values(),</span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>                                figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">8</span>))</span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>fig.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="facial-expression-recognition-transfer-learning_files/figure-html/cell-46-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
</section>
<section id="conclusion" class="level1">
<h1>Conclusion</h1>
<p>Using a partial MobileNet pretrained on ImageNet dataset, fine-tuning it, and adding some augmentation, we achieved here a test accuracy of about 63%.</p>
<p>I wondered whether some of this improvement might be simply due to the better training with shrinking learning rates (<a href="https://keras.io/api/callbacks/reduce_lr_on_plateau/">ReduceLROnPlateau callback</a>) and a higher number of training epochs (original model was trained only for 12 epochs, whereas here we wait until convergence), and data augmentation. I checked these in another notebook (to be published later): using the callback funtions, my training converged in 25 epochs, yielding a test score of ~55%, i.e., not different from the original score achieved by the simple <a href="https://www.kaggle.com/code/drcapa/facial-expression-eda-cnn/notebook">CNN model</a>) and using augmentation on top, the test score increased to about 57%. So the improvement due to model in isoluation is about 6%.</p>
<p>Although 6% can considered to be a significant improvement, on an absolute scale, 63% accuracy is not good score for an image classification task. It seems like this rather poor score has to do with: 1) the inherently difficult task of distinguishing subtle emotions like neutral vs.&nbsp;sad, and angry vs.&nbsp;surprised; 2) unbalanced dataset that includes a relatively low number of images for certain emotions like disgust (380 in total), for which, the model achieves the lowest accuracies as revealed by the confusion matrix; 3) rather poor data quality, as has been analsed elsewhere, e.g., as exemplifed in this nice <a href="https://www.kaggle.com/code/gauravsharma99/facial-emotion-recognition-using-transfer-learning/notebook">notebook</a> of <a href="https://www.kaggle.com/gauravsharma99">Gaurev Sharma</a>.</p>
<p>It has to be noted that the partial (first 12 blocks) MobileNet model we used here, although being a relatively small model with 2.17 M parameters (for comparison, see the <a href="https://keras.io/api/applications/">Keras Applications</a>), it is still vastly larger than the original CNN model with only 318 K parameters. Therefore the partial MobileNet model presented here needs more training time, space to store the final model, and may consequently cause latency issues.</p>
<p>That’s all for now, I hope you liked this notebook.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>